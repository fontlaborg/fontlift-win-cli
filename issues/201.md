## Font Management Tool Enhancements Plan

ContentsShare & Export

Create

# Implementation Plan: Enhanced `install` and `cleanup` Functionality

## I. Executive Overview

This document provides a comprehensive implementation plan for enhancing the
`fontlift-win-cli` utility with two new, high-value features requested by the
user. The objective is to integrate this functionality while strictly adhering
to the project's established architectural principles, which emphasize minimal
dependencies, robust error handling, and a clear separation of concerns.

**Project Goals:**

  1. **Modify`install` Command:** Implement logic to automatically uninstall any existing font that shares the same font family name as the font being installed.

  2. **Implement`cleanup` Command:** Introduce a new top-level command (`cleanup`, alias `c`) to perform system-wide font hygiene, including the removal of broken registry entries and the purging of all known system font caches.

**Implementation Strategy:** The plan is designed to be minimally invasive and
leverage existing code structures. All modifications will be contained within
the established architectural components:

  * **`src/main.cpp`:** CLI parsing and command handling.

  * **`src/font_ops.cpp`:** High-level font operations (install, list, etc.).

  * **`src/sys_utils.cpp`:** Low-level Windows API wrappers (registry, file I/O, service control).

  * **`src/font_parser.cpp`:** Font file-specific parsing logic.

No new third-party libraries will be introduced. All new functionality will be
implemented using the C++17 standard library and the existing Windows SDK
dependencies (Advapi32, User32, Shlwapi, Gdi32). All operations will maintain
the existing awareness of and support for both system-wide
(`HKEY_LOCAL_MACHINE`) and per-user (`HKEY_CURRENT_USER`) font installations.

## II. Feature 1: Automatic Uninstallation of Duplicate-Family Fonts

This feature enhances the `install` command to automatically find and remove a
previously installed font if it shares the same family name as the new font
being installed.

### A. Core Implementation Strategy

A naive implementation would require iterating the entire Windows font
registry, parsing every installed font file to extract its family name,
comparing it to the new font's family name, and then performing an
uninstallation. This approach is highly inefficient and duplicates existing
functionality.

A more elegant and efficient solution involves reusing the existing,
intelligent logic within `FontOps::UninstallFontByName`. This function does
not perform a simple string match; it intelligently calls
`FontOps::FindFontInRegistry`, which already searches for name variants,
including `Font Name (TrueType)`, `Font Name (OpenType)`, and the bare `Font
Name`. This is precisely the logic required to find a font by its "family
name."

However, a critical issue prevents direct reuse:
`FontOps::UninstallFontByName` is designed to return an `EXIT_ERROR` if the
specified font is _not_ found. If called directly from the `install` workflow,
this would incorrectly cause the installation to abort every time the user
installs a font that does not have a pre-existing version.

Therefore, the chosen strategy is to implement a new, non-aborting wrapper
function, `FontOps::TryUninstallExistingFont`. This function will use the
existing uninstallation logic but will gracefully handle the "font not found"
case as a non-error, allowing the `InstallFont` operation to proceed.

### B. New Function Implementation: `FontOps::TryUninstallExistingFont`

This new `static` helper function will be added to `src/font_ops.cpp`.

**File:** `src/font_ops.cpp` **Proposed Signature:**

C++

    
    
    static void TryUninstallExistingFont(const char* fontName, bool forceAdmin)
    

**Implementation Logic:** This function's logic will be a modified subset of
`FontOps::UninstallFontByName`.

  1. The function will _not_ perform an `IsEmptyOrWhitespace` check, as it will be called by `InstallFont` which has already validated the font name.

  2. It will _not_ perform an upfront admin check, as `InstallFont` is responsible for this.

  3. It will call `FindFontInRegistry(fontName, fontFile, matchedName, perUser, forceAdmin)`.

  4. **If a font is found** (`FindFontInRegistry` returns `true`):

     * It will check permissions for system fonts: `if (!perUser &&!SysUtils::IsAdmin())`. If privileges are insufficient, it will print a warning (`std::cerr << "Warning: Found older font '" << fontName << "' but cannot remove it without admin privileges.\n";`) and return.

     * It will call `UnloadAndCleanupFont(fontFile, matchedName, fontName, false, perUser)`. The `deleteFile` parameter must be `false`.

     * It will print a success notification: `std::cout << "Note: Automatically uninstalled older version of: " << fontName << "\n";`.

  5. **If a font is _not_ found** (`FindFontInRegistry` returns `false`):

     * The function will _not_ print an error.

     * It will return silently. This is the key modification that prevents the `install` operation from aborting.

### C. Modification of `FontOps::InstallFont`

To integrate this feature, the `FontOps::InstallFont` function will be
modified.

**File:** `src/font_ops.cpp` **Logic Change:** The order of operations at the
beginning of the function must be changed.

  1. The call to `ExtractFontName(fontPath, fontName)` will be moved to _before_ the call to `ValidateInstallPrerequisites`. The font file must be parsed first to retrieve the family name.

  2. If `ExtractFontName` fails (returns `EXIT_ERROR`), the `InstallFont` function will return immediately.

  3. A new line will be inserted immediately after `ExtractFontName` succeeds:

C++

         
         TryUninstallExistingFont(fontName.c_str(), forceAdmin);
         

  4. The function will then proceed as normal, calling `ValidateInstallPrerequisites`, `CopyToFontsFolder`, and `RegisterAndLoadFont`.

This modification ensures that a best-effort attempt is made to remove any
existing font with the same family name _before_ the new font is copied and
registered. This attempt correctly respects all user/system permission
contexts and does not interfere with the installation of the new font.

### D. Header File Updates

**File:** `src/font_ops.h` No changes are required. The new
`TryUninstallExistingFont` function will be a `static` (private) helper within
`font_ops.cpp`. The public-facing signature of `InstallFont` remains
unchanged.

## III. Feature 2: Implementation of `cleanup` Command

This feature introduces a new top-level command, `cleanup` (alias `c`), to
perform system-wide font hygiene. This operation is inherently privileged and
will require administrator rights. The command will perform two distinct
tasks: (1) scan the registry for and remove entries pointing to non-existent
files, and (2) purge all system-level font caches.

### A. CLI Integration (Command Parsing)

Modifications are required in `src/main.cpp` to add the new command.

**File:** `src/main.cpp`

**1\. Modification to`ShowUsage`:** The `ShowUsage` function will be updated
to include the new command:

C++

    
    
    //... after 'remove' command block...
    std::cout << " cleanup, c         Perform system cleanup (requires admin)\n";
    std::cout << "                    - Removes broken registry entries\n";
    std::cout << "                    - Clears all system font caches\n\n";
    

**2\. Modification to`main` function:** The `main` function will be updated to
handle the new command:

C++

    
    
    //... after 'remove' block...
    if (strcmp(command, "cleanup") == 0 |
    
    | strcmp(command, "c") == 0) {
        return HandleCleanupCommand();
    }
    //... before 'Unknown command' error...
    

**3\. New Function:`HandleCleanupCommand`:** A new `static` helper function
will be added to `src/main.cpp` to orchestrate the cleanup.

C++

    
    
    static int HandleCleanupCommand() {
        // Administrator privileges are mandatory for this operation.
        if (!SysUtils::IsAdmin()) {
            std::cerr << "Error: Administrator privileges are required for the cleanup command.\n";
            std::cerr << "Solution: Right-click Command Prompt and select 'Run as administrator'.\n";
            return EXIT_PERMISSION_DENIED;
        }
    
        std::cout << "Starting system cleanup...\n";
        int result = FontOps::CleanupSystem();
        if (result == EXIT_SUCCESS_CODE) {
            std::cout << "System cleanup completed successfully.\n";
        }
        return result;
    }
    

This handler correctly performs the permission check as its first action,
providing a clear error message if privileges are insufficient.

### B. New Orchestration Function: `FontOps::CleanupSystem`

This new high-level function will orchestrate the two cleanup tasks.

**File:** `src/font_ops.h` A new public function signature will be added:

C++

    
    
    // Perform system cleanup (remove broken registry entries, clear caches)
    // Must be run as administrator.
    int CleanupSystem();
    

**File:** `src/font_ops.cpp` The new function implementation will be added:

C++

    
    
    namespace FontOps {
        //... other static helpers...
        static int CleanupRegistry(); // Forward declaration
    
        int FontOps::CleanupSystem() {
            std::cout << "Scanning font registry for broken entries...\n";
            int brokenEntries = CleanupRegistry();
            
            if (brokenEntries < 0) {
                std::cerr << "Error: Failed to scan font registry.\n";
                // Do not abort; cache cleanup can still proceed.
            } else {
                std::cout << "Found and removed " << brokenEntries << " broken font entries.\n";
            }
    
            std::cout << "Clearing system font caches...\n";
            if (!SysUtils::ClearFontCaches()) {
                std::cerr << "Error: Failed to clear one or more font caches.\n";
                return EXIT_ERROR; 
            }
    
            std::cout << "Font caches cleared successfully.\n";
            return EXIT_SUCCESS_CODE;
        }
        //...
    }
    

### C. Task 1: Registry Hygiene (Implementation)

This task implements the `CleanupRegistry` helper function.

**File:** `src/font_ops.cpp`

**1\. Required Modification to`SysUtils::RegEnumerateFonts`:** To determine if
a broken registry entry is in the system or per-user hive, the enumeration
callback must receive the `perUser` context. This requires a modification to
`SysUtils::RegEnumerateFonts`.

  * **Old Signature:** `void (*callback)(const char* name, const char* file)`

  * **New Signature:** `void (*callback)(const char* name, const char* file, bool perUser)`

  * **File:** `src/sys_utils.cpp`

    * The call to the callback must be updated:

C++

          
          // Old:
          // callback(valueName, reinterpret_cast<const char*>(valueData));
          // New:
          callback(valueName, reinterpret_cast<const char*>(valueData), perUser);
          

**2\. Required Update to`FontOps::ListCallback`:** This modification is a
breaking change for the existing `ListFonts` command. The `ListCallback`
function must be updated to match the new signature, even if it does not use
the new parameter.

  * **File:** `src/font_ops.cpp`

  * **Old Signature:** `static void ListCallback(const char* name, const char* file)`

  * **New Signature:** `static void ListCallback(const char* name, const char* file, bool perUser)`

**3\. New Registry Cleanup Implementation:** New static components will be
added to `src/font_ops.cpp`.

C++

    
    
    // Context struct for the cleanup callback
    static struct {
        int removeCount;
        bool changed;
        std::string fontsDir;
        std::string userFontsDir;
    } g_cleanupContext;
    
    // Callback function to check file existence and remove broken entries
    static void CleanupCallback(const char* name, const char* file, bool perUser) {
        std::string fullPath;
        
        // Resolve the full path, handling absolute (per-user) and relative (system) paths
        size_t fileLen = strlen(file);
        bool isAbsolute = (fileLen > 0 && file == '\\') |
    
    | (fileLen > 1 && file == ':');
    
        if (isAbsolute) {
            fullPath = file;
        } else {
            fullPath = perUser? g_cleanupContext.userFontsDir : g_cleanupContext.fontsDir;
            fullPath += "\\";
            fullPath += file;
        }
    
        if (!SysUtils::FileExists(fullPath.c_str())) {
            std::cout << "  - Removing broken entry: " << name << "\n";
            std::cout << "    File not found: " << fullPath << "\n";
            
            if (SysUtils::RegDeleteFontEntry(name, perUser)) {
                g_cleanupContext.removeCount++;
                g_cleanupContext.changed = true;
            } else {
                std::cerr << "    Warning: Failed to remove registry entry.\n";
            }
        }
    }
    
    // Orchestrator for registry cleanup
    static int CleanupRegistry() {
        g_cleanupContext.removeCount = 0;
        g_cleanupContext.changed = false;
        g_cleanupContext.fontsDir = SysUtils::GetFontsDirectory();
        g_cleanupContext.userFontsDir = SysUtils::GetUserFontsDirectory();
    
        if (g_cleanupContext.fontsDir.empty() |
    
    | g_cleanupContext.userFontsDir.empty()) {
            std::cerr << "Error: Could not determine font directories.\n";
            return -1; // Indicates failure
        }
    
        // Enumerate system fonts
        if (!SysUtils::RegEnumerateFonts(CleanupCallback, false)) {
            std::cerr << "Error: Failed to enumerate system fonts.\n";
            return -1; // Indicates failure
        }
        
        // Enumerate user fonts
        SysUtils::RegEnumerateFonts(CleanupCallback, true);
    
        if (g_cleanupContext.changed) {
            SysUtils::NotifyFontChange();
        }
        
        return g_cleanupContext.removeCount;
    }
    

### D. Task 2: Font Cache Purge (New Low-Level Implementation)

This task requires new, privileged operations to be added to
`src/sys_utils.cpp`.

**File:** `src/sys_utils.h` A new public function signature will be added:

C++

    
    
    // Stops, deletes, and restarts the system font cache.
    // Returns true on success. Must be run as administrator.
    bool ClearFontCaches();
    

**File:** `src/sys_utils.cpp` The following new components will be added:

  1. **Required Include:** A new standard library header will be required for recursive directory deletion. This aligns with the C++17 project standard and does not add a third-party dependency.

C++

         
         #include <filesystem> // For std::filesystem::remove_all
         

  2. **New Helper:`ManageFontCacheService`** A new `static` helper function will be added to stop and start the Windows Font Cache Service.

     * **Logic:** This function will use the Windows Service Control Manager API  to interact with the service named `FontCache` (identified in ).  

     * It will use `OpenSCManager` to connect, `OpenServiceW` to get a handle to the `FontCache` service, and `ControlService` (with `SERVICE_CONTROL_STOP`) or `StartService` to manage its state.  

     * **Robustness:** After sending a stop or start request, the function _must_ enter a wait loop (e.g., 30-second timeout). Inside the loop, it will poll `QueryServiceStatusEx` to wait until the service's `dwCurrentState` is confirmed to be `SERVICE_STOPPED` or `SERVICE_RUNNING`, respectively. This ensures the cache files are not in use when deletion is attempted.  

  3. **New Helper:`DeleteCacheFiles`** A new `static` helper function will be added to delete the cache files from their protected locations.  

     * **Target 1:** The primary cache file `C:\Windows\System32\FNTCACHE.DAT`. This will be deleted using `DeleteFileA`. "File not found" errors will be ignored (treated as success).

     * **Target 2:** The service cache directory `C:\Windows\ServiceProfiles\LocalService\AppData\Local\FontCache`. This will be deleted recursively using `std::filesystem::remove_all`.

     * **Deferred Targets:** Per-user caches (e.g., `%localappdata%\FontCache` ) are not targeted in this implementation. Cleaning these would require complex enumeration of all user profiles on the machine. The `cleanup` command, being an administrator-only function, will focus on the system-wide caches, which are the most common source of corruption.  

  4. **New Public Function:`SysUtils::ClearFontCaches`** This function will orchestrate the cache-clearing process.

C++

         
         bool SysUtils::ClearFontCaches() {
             std::cout << "  - Stopping Windows Font Cache Service (FontCache)...\n";
             if (!ManageFontCacheService(true)) { // true = stop
                 std::cerr << "    Error: Failed to stop font cache service.\n";
                 return false;
             }
         
             std::cout << "  - Deleting cache files...\n";
             if (!DeleteCacheFiles()) {
                 std::cerr << "    Warning: Could not delete all cache files.\n";
                 // Do not abort; always attempt to restart the service.
             }
         
             std::cout << "  - Starting Windows Font Cache Service (FontCache)...\n";
             if (!ManageFontCacheService(false)) { // false = start
                 std::cerr << "    Error: Failed to restart font cache service.\n";
                 return false;
             }
         
             return true;
         }
         

### E. Key Implementation Table: Font Cache Purge

To ensure precise implementation of the cache purge, the following targets are
specified. This operation must be executed in the order listed.

Target Type| Target Identifier| Required Action| Data Source(s)  
---|---|---|---  
**Service**| `FontCache`| **1\. Stop** (Wait for `SERVICE_STOPPED`)| [2, 4, 5]  
**File**| `C:\Windows\System32\FNTCACHE.DAT`| **2\. Delete** (Ignore "Not
Found" errors)| [9, 10, 11]  
**Directory**|
`C:\Windows\ServiceProfiles\LocalService\AppData\Local\FontCache`| **3\.
Delete Recursively** (Delete folder and all contents)| [5, 8, 10]  
**Service**| `FontCache`| **4\. Start** (Wait for `SERVICE_RUNNING`)| [2, 4,
5]  
  
Export to Sheets

## IV. Updates to Project Documentation

Upon completion of the implementation, the following project documentation
must be updated to reflect the new functionality.

### A. `README.md`

The main `README.md` will be updated:

  1. **Usage Section:** A new example for the `cleanup` command will be added.

DOS

         
         ### System Cleanup (Requires Admin)
         fontlift-win cleanup
         fontlift-win c
         

  2. **Commands Table:** A new row will be added.

| `cleanup` | `c` | Removes broken registry entries and clears system font caches (requires admin) | 3\. **Troubleshooting Section:** A note will be added suggesting `fontlift-win cleanup` as a potential fix for font rendering issues.

### B. `CHANGELOG.md`

A new `[Unreleased]` section will be added to `CHANGELOG.md` with the
following entries:

## [Unreleased]

### Added

  * New `cleanup` (alias `c`) command to perform system-wide font hygiene. This command requires administrator privileges.

    * Scans the Windows font registry and removes any entries that point to non-existent font files (both system and per-user).

    * Purges system-level font caches by stopping the `FontCache` service, deleting cache files (including `FNTCACHE.DAT`), and restarting the service.

  * The `install` command now automatically attempts to uninstall any existing font with the same font family name before proceeding with the new installation. This helps prevent duplicate-family fonts.

### C. `PLAN.md` and `TODO.md`

Internal planning documents will be updated to mark the tasks associated with
this implementation plan as complete.

Sources used in the report

![](https://drive-thirdparty.googleusercontent.com/32/type/text/plain)

llms.txt

[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comProgrammatically
restart a Windows Service - c++ - Stack Overflow Opens in a new window
](https://stackoverflow.com/questions/6126443/programmatically-restart-a-
windows-
service)[![](https://t3.gstatic.com/faviconV2?url=https://www.codeproject.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)codeproject.comInteract
with Windows Services in C++ - CodeProject Opens in a new window
](https://www.codeproject.com/articles/Interact-with-Windows-Services-in-
Cplusplus)[![](https://t3.gstatic.com/faviconV2?url=https://batcmd.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)batcmd.comWindows
Font Cache Service - batcmd.com Opens in a new window
](https://batcmd.com/windows/10/services/fontcache/)[![](https://t0.gstatic.com/faviconV2?url=https://gist.github.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)gist.github.comRebuild
font cache in Windows and reboot your computer in order to solve some font
rendering issues - GitHub Gist Opens in a new window
](https://gist.github.com/brainplot/19816ff07a0c31efee005d34271650e3)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comStopping
a Service - Win32 apps - Microsoft Learn Opens in a new window
](https://learn.microsoft.com/en-us/windows/win32/services/stopping-a-
service)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comStarting
a Service - Win32 apps - Microsoft Learn Opens in a new window
](https://learn.microsoft.com/en-us/windows/win32/services/starting-a-
service)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comHow
to clear the Windows font cache? - Microsoft Learn Opens in a new window
](https://learn.microsoft.com/en-us/answers/questions/3860093/how-to-clear-
the-windows-font-cache)[![](https://t3.gstatic.com/faviconV2?url=https://luzi-
type.ch/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)luzi-
type.chSometimes Desktop Fonts do not appear in program menus. In almost all
such cases, the problem can be resolved by clearing the Font Cache. - Notes –
Luzi Type Foundry Opens in a new window ](https://luzi-type.ch/notes-font-
cache)[![](https://t0.gstatic.com/faviconV2?url=https://www.wisecleaner.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)wisecleaner.comHow
to Clear Font Cache in Windows 11 - WiseCleaner Opens in a new window
](https://www.wisecleaner.com/how-to/326-how-to-clear-font-cache-in-
windows-11.html)[![](https://t1.gstatic.com/faviconV2?url=https://www.isunshare.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)isunshare.comHow
to Delete Font Cache in Windows 10 - iSunshare Opens in a new window
](https://www.isunshare.com/windows-10/how-to-delete-font-cache-in-
windows-10.html)[![](https://t0.gstatic.com/faviconV2?url=https://winsides.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)winsides.com5+
Easy Methods to Delete Font Cache in Windows 11! - Winsides.com Opens in a new
window ](https://winsides.com/5-easy-methods-to-delete-font-cache-in-
windows-11/)

Sources read but not used in the report

[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comHow to programmatically clear the filesystem memory cache in C++ on a Linux system? Opens in a new window ](https://stackoverflow.com/questions/6818606/how-to-programmatically-clear-the-filesystem-memory-cache-in-c-on-a-linux-syst)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comHow to clear memory cached files programmatically with C++? Specifically Notepad cache? Opens in a new window ](https://learn.microsoft.com/en-us/answers/questions/1866351/how-to-clear-memory-cached-files-programmatically)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comc++ - Flushing the cache to prevent benchmarking fluctiations - Stack Overflow Opens in a new window ](https://stackoverflow.com/questions/34460744/flushing-the-cache-to-prevent-benchmarking-fluctiations)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comWindows with C++ - Exploring Fonts with DirectWrite and Modern C++ - Microsoft Learn Opens in a new window ](https://learn.microsoft.com/en-us/archive/msdn-magazine/2013/november/windows-with-c-exploring-fonts-with-directwrite-and-modern-c)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comGet a font filepath from name and style in C++/Windows - Stack Overflow Opens in a new window ](https://stackoverflow.com/questions/11387564/get-a-font-filepath-from-name-and-style-in-c-windows)[![](https://t2.gstatic.com/faviconV2?url=https://www.exploit-db.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)exploit-db.comMicrosoft Windows Font Cache Service - Insecure Sections Privilege Escalation - Exploit-DB Opens in a new window ](https://www.exploit-db.com/exploits/47029)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comHow do you delete system-protected fonts? - Microsoft Q&A Opens in a new window ](https://learn.microsoft.com/en-us/answers/questions/3721095/how-do-you-delete-system-protected-fonts)[![](https://t0.gstatic.com/faviconV2?url=https://superuser.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)superuser.comwindows 7 - What is the purpose of the Fonts key in the Registry? - Super User Opens in a new window ](https://superuser.com/questions/813039/what-is-the-purpose-of-the-fonts-key-in-the-registry)[![](https://t1.gstatic.com/faviconV2?url=https://helpcenter.trendmicro.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)helpcenter.trendmicro.comSafely Clean Your Windows Registry: Step-By-Step Guide | Trend Micro Help Center Opens in a new window ](https://helpcenter.trendmicro.com/en-us/article/tmka-20814)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comWindows registry information for advanced users - Microsoft Learn Opens in a new window ](https://learn.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comFonts are shown in the Windows 10 registry but can't find them in C:\Windows\Fonts Opens in a new window ](https://learn.microsoft.com/en-us/answers/questions/936980/fonts-are-shown-in-the-windows-10-registry-but-can)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comDeleting Fonts from Windows 10 that don't appear in regedit - Microsoft Learn Opens in a new window ](https://learn.microsoft.com/en-us/answers/questions/3185680/deleting-fonts-from-windows-10-that-dont-appear-in)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comCan't query, run or stop a Windows Service - c++ - Stack Overflow Opens in a new window ](https://stackoverflow.com/questions/39326284/cant-query-run-or-stop-a-windows-service)

Thoughts

Deconstructing the Request

I am starting by breaking down your request into two main features. The first
is to automatically uninstall an old font when a new one with the same family
name is installed. The second is to create a new 'cleanup' command to remove
fonts whose files are missing and to clear all system font caches.

Analyzing the Codebase

My primary focus is on modifying the existing code. I'll be examining the
`font_ops.cpp` file to understand the current installation logic,
`font_parser.cpp` to see how font names are extracted, and `main.cpp` to
determine how to add the new 'cleanup' command.

Investigating System-Level Changes

The font cache cleaning portion of the 'cleanup' command requires new
information. I'll need to investigate how to programmatically interact with
the Windows Font Cache Service, find the cache file locations (like
`FNTCACHE.DAT`), and identify any relevant registry keys.

Formulating the Plan

After analyzing the code and researching the cache-clearing process, I will
synthesize all this information. The final goal is to produce an extensive
`PLAN.md` document detailing the exact implementation steps for both new
features, as well as updating the `TODO.md` and `CHANGELOG.md` files to match.

Researching uploaded files

![](https://drive-thirdparty.googleusercontent.com/32/type/text/plain)

llms.txt

![](https://www.gstatic.com/lamda/images/immersives/google_logo_icon_2380fba942c84387f09cf.svg)

Researching websites

[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comHow to programmatically clear the filesystem memory cache in C++ on a Linux system?](https://stackoverflow.com/questions/6818606/how-to-programmatically-clear-the-filesystem-memory-cache-in-c-on-a-linux-syst)[![](https://t3.gstatic.com/faviconV2?url=https://luzi-type.ch/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)luzi-type.chSometimes Desktop Fonts do not appear in program menus. In almost all such cases, the problem can be resolved by clearing the Font Cache. - Notes – Luzi Type Foundry](https://luzi-type.ch/notes-font-cache)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comHow to clear memory cached files programmatically with C++? Specifically Notepad cache?](https://learn.microsoft.com/en-us/answers/questions/1866351/how-to-clear-memory-cached-files-programmatically)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comc++ - Flushing the cache to prevent benchmarking fluctiations - Stack Overflow](https://stackoverflow.com/questions/34460744/flushing-the-cache-to-prevent-benchmarking-fluctiations)[![](https://t3.gstatic.com/faviconV2?url=https://batcmd.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)batcmd.comWindows Font Cache Service - batcmd.com](https://batcmd.com/windows/10/services/fontcache/)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comWindows with C++ - Exploring Fonts with DirectWrite and Modern C++ - Microsoft Learn](https://learn.microsoft.com/en-us/archive/msdn-magazine/2013/november/windows-with-c-exploring-fonts-with-directwrite-and-modern-c)[![](https://t0.gstatic.com/faviconV2?url=https://gist.github.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)gist.github.comRebuild font cache in Windows and reboot your computer in order to solve some font rendering issues - GitHub Gist](https://gist.github.com/brainplot/19816ff07a0c31efee005d34271650e3)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comGet a font filepath from name and style in C++/Windows - Stack Overflow](https://stackoverflow.com/questions/11387564/get-a-font-filepath-from-name-and-style-in-c-windows)[![](https://t2.gstatic.com/faviconV2?url=https://www.exploit-db.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)exploit-db.comMicrosoft Windows Font Cache Service - Insecure Sections Privilege Escalation - Exploit-DB](https://www.exploit-db.com/exploits/47029)[![](https://t0.gstatic.com/faviconV2?url=https://www.wisecleaner.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)wisecleaner.comHow to Clear Font Cache in Windows 11 - WiseCleaner](https://www.wisecleaner.com/how-to/326-how-to-clear-font-cache-in-windows-11.html)[![](https://t0.gstatic.com/faviconV2?url=https://winsides.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)winsides.com5+ Easy Methods to Delete Font Cache in Windows 11! - Winsides.com](https://winsides.com/5-easy-methods-to-delete-font-cache-in-windows-11/)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comHow to clear the Windows font cache? - Microsoft Learn](https://learn.microsoft.com/en-us/answers/questions/3860093/how-to-clear-the-windows-font-cache)[![](https://t1.gstatic.com/faviconV2?url=https://www.isunshare.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)isunshare.comHow to Delete Font Cache in Windows 10 - iSunshare](https://www.isunshare.com/windows-10/how-to-delete-font-cache-in-windows-10.html)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comHow do you delete system-protected fonts? - Microsoft Q&A](https://learn.microsoft.com/en-us/answers/questions/3721095/how-do-you-delete-system-protected-fonts)[![](https://t0.gstatic.com/faviconV2?url=https://superuser.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)superuser.comwindows 7 - What is the purpose of the Fonts key in the Registry? - Super User](https://superuser.com/questions/813039/what-is-the-purpose-of-the-fonts-key-in-the-registry)[![](https://t1.gstatic.com/faviconV2?url=https://helpcenter.trendmicro.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)helpcenter.trendmicro.comSafely Clean Your Windows Registry: Step-By-Step Guide | Trend Micro Help Center](https://helpcenter.trendmicro.com/en-us/article/tmka-20814)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comWindows registry information for advanced users - Microsoft Learn](https://learn.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comFonts are shown in the Windows 10 registry but can't find them in C:\Windows\Fonts](https://learn.microsoft.com/en-us/answers/questions/936980/fonts-are-shown-in-the-windows-10-registry-but-can)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comDeleting Fonts from Windows 10 that don't appear in regedit - Microsoft Learn](https://learn.microsoft.com/en-us/answers/questions/3185680/deleting-fonts-from-windows-10-that-dont-appear-in)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comProgrammatically restart a Windows Service - c++ - Stack Overflow](https://stackoverflow.com/questions/6126443/programmatically-restart-a-windows-service)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comStopping a Service - Win32 apps - Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/services/stopping-a-service)[![](https://t3.gstatic.com/faviconV2?url=https://learn.microsoft.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)learn.microsoft.comStarting a Service - Win32 apps - Microsoft Learn](https://learn.microsoft.com/en-us/windows/win32/services/starting-a-service)[![](https://t3.gstatic.com/faviconV2?url=https://www.codeproject.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)codeproject.comInteract with Windows Services in C++ - CodeProject](https://www.codeproject.com/articles/Interact-with-Windows-Services-in-Cplusplus)[![](https://t0.gstatic.com/faviconV2?url=https://stackoverflow.com/&client=BARD&type=FAVICON&size=256&fallback_opts=TYPE,SIZE,URL)stackoverflow.comCan't query, run or stop a Windows Service - c++ - Stack Overflow](https://stackoverflow.com/questions/39326284/cant-query-run-or-stop-a-windows-service)

Researching uploaded files

![](https://drive-thirdparty.googleusercontent.com/32/type/text/plain)

llms.txt

Pivoting the Plan

My initial analysis of the provided project files reveals they are high-level
documentation, not the full source code. This is a key insight. It means I
cannot modify existing code directly. Instead, I will architect the
implementation plan *as if* I were writing the functions from scratch,
ensuring my plan fits perfectly into the documented file structure and
respects the intended purpose of each file.

Successful Cache Investigation

My research into the 'cleanup' command's cache-clearing feature was highly
effective. I've confirmed the programmatic method for implementation: I must
first stop the 'FontCache' service, then delete specific files from
`C:\Windows\System32` and
`C:\Windows\ServiceProfiles\LocalService\AppData\Local`, and finally restart
the service. This avoids risky registry edits and provides a clear path
forward.

Mapping the 'Install' Feature

For the automatic uninstall feature, I've mapped out the logic. The
`InstallFont` function will first use the `font_parser` logic to get the new
font's family name. It will then check the registry for a font with the same
name. If a conflict is found, it will call the existing `UninstallFontByName`
function on the *old* font before proceeding to install the new one.

Designing the 'Cleanup' Command

I'm designing the 'cleanup' command in two parts. First, it will iterate
through the Windows font registry and check if the associated font file still
exists, removing any orphaned entries. Second, it will perform the
programmatic cache-clearing steps I've already researched. This entire process
will be encapsulated in a new `CleanupFonts` function, called from `main.cpp`
after an administrator-rights check.

Crafting the Documentation

I was unable to view the *content* of your existing documentation files, but
the project rules clearly state their *purpose*. Therefore, I will create the
`PLAN.md`, `TODO.md`, and `CHANGELOG.md` entries from scratch, adhering to the
formats you've defined: a detailed plan, a simplified checklist, and a new
version entry.

Finalizing the Implementation Plan

I now have all the necessary components: the architectural plan for the
codebase, the specific system-level commands for cache cleaning, and the
documentation strategy. I do not need any further research and will now move
to synthesize these findings into the final, comprehensive `PLAN.md` document.
